#!/bin/bash
# Full development environment for Gambit
# Builds the project and runs 1 server + 4 clients

set -e

# Build the project
echo "Building Gambit..."
mkdir -p build
cd build
cmake ..
make
cd ..

echo "Starting development environment..."
echo ""

# Start the server
./build/Server &
SERVER_PID=$!
echo "Server started (PID: $SERVER_PID)"

# Start 4 clients with delays
CLIENT_PIDS=()
for i in {1..4}; do
    ./build/Client &
    CLIENT_PIDS+=($!)
    echo "Client $i started (PID: ${CLIENT_PIDS[$i-1]})"
    sleep 1
done

echo ""
echo "Development environment running:"
echo "  1 Server (PID: $SERVER_PID)"
echo "  4 Clients (PIDs: ${CLIENT_PIDS[@]})"
echo ""

# Wait for user input to terminate
read -p "Press Enter to terminate all processes..."

echo ""
echo "Shutting down..."

# Gracefully stop the server and clients
kill -SIGINT $SERVER_PID 2>/dev/null || true
for pid in "${CLIENT_PIDS[@]}"; do
    kill -SIGINT $pid 2>/dev/null || true
done

# Wait for processes to finish
wait $SERVER_PID 2>/dev/null || true
for pid in "${CLIENT_PIDS[@]}"; do
    wait $pid 2>/dev/null || true
done

echo "All processes terminated."
