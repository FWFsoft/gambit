name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  native-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          pkg-config \
          libx11-dev \
          libxft-dev \
          libxext-dev \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libibus-1.0-dev \
          autoconf \
          autoconf-archive \
          automake \
          libtool

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '15e5f3820f0370f1ba7150853762cec0688cd396'

    - name: Configure CMake
      run: cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake

    - name: Build
      run: cmake --build build

    - name: Run tests
      run: cd build && ctest --output-on-failure

  wasm-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.74'

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build-wasm/_deps
        key: wasm-fetchcontent-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          wasm-fetchcontent-

    - name: Configure CMake
      run: |
        mkdir -p build-wasm
        cd build-wasm
        emcmake cmake ..

    - name: Build
      run: cmake --build build-wasm

    - name: Verify output files
      run: |
        test -f build-wasm/WasmClient.html
        test -f build-wasm/WasmClient.js
        test -f build-wasm/WasmClient.wasm
        test -f build-wasm/WasmClient.data
        echo "All WASM output files present"
        ls -lh build-wasm/WasmClient.*

    - name: Prepare Pages artifact
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p _site
        cp build-wasm/WasmClient.html _site/index.html
        cp build-wasm/WasmClient.js   _site/WasmClient.js
        cp build-wasm/WasmClient.wasm _site/WasmClient.wasm
        cp build-wasm/WasmClient.data _site/WasmClient.data

    - name: Upload Pages artifact
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy-pages:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: wasm-build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
